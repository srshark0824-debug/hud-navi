<body>
  <h2>HUDナビ デモ</h2>
  <input id="destinationInput" type="text" placeholder="目的地を入力 (例: 東京駅)">
  <button onclick="setDestination()">目的地設定</button>
  <button onclick="enableSensors()">モーション許可</button>

  <p id="status"></p>
  <canvas id="arrowCanvas" width="300" height="300"></canvas>

  <script>
    let destination = null;
    let currentPosition = null;

    async function setDestination() {
      const place = document.getElementById("destinationInput").value;
      if (!place) return alert("目的地を入力してください");

      const apiKey =AIzaSyDHRitaxXlwj13-dz9zPKpwvhGZorwzgRY;
      const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(place)}&key=${apiKey}`;

      const res = await fetch(url);
      const data = await res.json();
      if (data.results.length === 0) {
        document.getElementById("status").textContent = "場所が見つかりません";
        return;
      }

      destination = data.results[0].geometry.location;
      document.getElementById("status").textContent = `${place} に設定しました`;
    }

    // 現在地を取得
    navigator.geolocation.watchPosition((pos) => {
      currentPosition = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };
      updateHUD();
    });

    function updateHUD() {
      if (!destination || !currentPosition) return;

      // 方向と距離を計算
      const R = 6371000; // 地球の半径（m）
      const toRad = (deg) => (deg * Math.PI) / 180;
      const dLat = toRad(destination.lat - currentPosition.lat);
      const dLng = toRad(destination.lng - currentPosition.lng);

      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(currentPosition.lat)) *
        Math.cos(toRad(destination.lat)) *
        Math.sin(dLng / 2) ** 2;

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c;

      document.getElementById("status").textContent =
        `目的地まで約 ${Math.round(distance)}m`;
    }

    // iPhoneのモーション許可
    async function enableSensors() {
      if (typeof DeviceMotionEvent.requestPermission === "function") {
        const permission = await DeviceMotionEvent.requestPermission();
        if (permission === "granted") {
          alert("モーションセンサーが有効になりました");
        }
      } else {
        alert("モーションセンサー対応デバイスで開いてください");
      }
    }
  </script>
</body>
