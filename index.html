<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HUDãƒŠãƒ“ï¼ˆæ–¹ä½å®‰å®šç‰ˆï¼‰</title>
<style>
  body {
    background: black;
    color: rgb(0, 255, 13);
    font-family: monospace;
    text-align: center;
    margin-top: 10vh;
  }

  #arrow {
    width: 150px;
    height: 150px;
    margin: 0 auto;
    background: url('arrow.png') no-repeat center;
    background-size: contain;
    transform-origin: 50% 60%;
    transition: transform 0.3s linear;
    filter: drop-shadow(0 0 10px red);
  }

  #info {
    margin-top: 20px;
  }
</style>
</head>
<body>
  <h2>HUDãƒŠãƒ“</h2>
  <div id="arrow"></div>
  <p id="info">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
  <button id="startBtn">â–¶ï¸ ãƒŠãƒ“é–‹å§‹</button>

<script>
const API_KEY = "AIzaSyDHRitaxXlwj13-dz9zPKpwvhGZorwzgRY";
let destination = null;
let headingOffset = 0;
let arrived = false;

// â–¼ æ—¥æœ¬ã®ç£åè§’ï¼ˆç£åŒ— â†’ çœŸåŒ—è£œæ­£ï¼‰
const DECLINATION = 7;

// â–¼ æ–¹ä½å®‰å®šåŒ–ãƒãƒƒãƒ•ã‚¡
let headingHistory = [];

// ==============================
//  æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ï¼ˆiOS / Androidå¯¾å¿œï¼‰
// ==============================
async function enableOrientation() {
  if (typeof DeviceOrientationEvent.requestPermission === "function") {
    const permission = await DeviceOrientationEvent.requestPermission();
    if (permission !== "granted") {
      alert("ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚");
      return;
    }
  }

  window.addEventListener("deviceorientation", (e) => {
    let heading;

    if (e.webkitCompassHeading !== undefined) {
      // iPhoneï¼ˆç£åŒ—åŸºæº–ï¼‰
      heading = e.webkitCompassHeading;
    } else if (e.alpha !== null) {
      // Androidï¼ˆåº§æ¨™è»¸ã®é–¢ä¿‚ã§åè»¢ãŒå¿…è¦ï¼‰
      heading = 360 - e.alpha;
    } else {
      return;
    }

    // â–¼ ç§»å‹•å¹³å‡ã§å®‰å®šåŒ–ï¼ˆ5å›åˆ†ï¼‰
    headingHistory.push(heading);
    if (headingHistory.length > 5) headingHistory.shift();

    const avg = headingHistory.reduce((a, b) => a + b, 0) / headingHistory.length;

    // â–¼ ç£åŒ— â†’ çœŸåŒ—ã«å¤‰æ›
    headingOffset = (avg + DECLINATION + 360) % 360;
  });
}

// ==============================
//  åœ°åæ¤œç´¢
// ==============================
// ğŸ”¥ è¤‡æ•°ã®ç›®çš„åœ°ã‚’å–å¾—ã—ã¦é…åˆ—ã«å…¥ã‚Œã‚‹
async function askDestination() {

  // ç›®çš„åœ°å…¥åŠ›ã®ãƒ«ãƒ¼ãƒ—
  while (true) {
    let place = prompt(`ç›®çš„åœ° ${destinations.length + 1} ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šäº¬éƒ½é§…ï¼‰`);
    if (!place) break;

    // --- Google APIã§æ¤œç´¢ ---
    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(place)}&key=${API_KEY}`;
    const res = await fetch(url);
    const data = await res.json();

    if (data.results.length === 0) {
      alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®åç§°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      continue; // å†å…¥åŠ›ã¸æˆ»ã‚‹
    }

    const result = data.results[0];
    const loc = result.geometry.location;
    const officialName = result.formatted_address;

    // --- æ­£å¼åç§°ã§ç¢ºèª ---
    const ok = confirm(`ã€Œ${officialName}ã€ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
    if (!ok) continue;  // å†å…¥åŠ›ã¸æˆ»ã‚‹

    // --- é…åˆ—ã«è¿½åŠ  ---
    destinations.push({
      name: officialName,
      lat: loc.lat,
      lon: loc.lng
    });

    // --- æ¬¡ã®ç›®çš„åœ°å…¥åŠ›ç¢ºèª ---
    const addMore = confirm("æ¬¡ã®ç›®çš„åœ°ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿï¼ˆã¯ã„ï¼è¿½åŠ  / ã„ã„ãˆï¼ãƒŠãƒ“é–‹å§‹ï¼‰");
    if (!addMore) break;
  }

  if (destinations.length === 0) {
    alert("ç›®çš„åœ°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  // ãƒŠãƒ“é–‹å§‹
  document.getElementById("info").innerText =
    `ç›®çš„åœ° 1ï¼š${destinations[0].name}\nç¾åœ¨åœ°ã‚’å–å¾—ä¸­...`;

  startNavigation();
}

}

// ==============================
//  è·é›¢è¨ˆç®—
// ==============================
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(Î”Ï† / 2)**2 +
            Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// ==============================
//  æ–¹ä½è§’ï¼ˆçœŸåŒ—åŸºæº–ï¼‰
// ==============================
function getBearing(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI / 180;
  const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
  const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
            Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

// ==============================
//  ãƒŠãƒ“é–‹å§‹ï¼ˆGPSç²¾åº¦å…¥ã‚Šï¼‰
// ==============================
function startNavigation() {
  navigator.geolocation.watchPosition(pos => {
    if (arrived) return;

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;

    // --- ç¾åœ¨ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåœ°ç‚¹ ---
    const target = destinations[currentIndex];

    const bearing = getBearing(lat, lon, target.lat, target.lon);
    const distance = getDistance(lat, lon, target.lat, target.lon);
    const correctedBearing = (bearing + headingOffset + 360) % 360;

    // --- GPSç²¾åº¦è¡¨ç¤º ---
    let gpsStatus = "ã€‡";
    if (acc > 30) gpsStatus = "â–³";
    if (acc > 100) gpsStatus = "âœ–";

    // --- åˆ°ç€åˆ¤å®šï¼ˆæ¬¡ã®ç›®çš„åœ°ã¸é€²ã‚€ï¼‰ ---
    if (distance < 50 && acc < 30) {

      // æœ€çµ‚ç›®çš„åœ°ã‹ï¼Ÿ
      if (currentIndex === destinations.length - 1) {
        arrived = true;
        document.getElementById("info").innerText = "ğŸ‰ å…¨ã¦ã®ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸï¼";
        document.getElementById("arrow").style.display = "none";
        return;
      }

      // æ¬¡ã®ç›®çš„åœ°ã¸
      currentIndex++;
      const next = destinations[currentIndex];
      alert(`ç›®çš„åœ° ${currentIndex} ã«åˆ°ç€ã—ã¾ã—ãŸï¼\næ¬¡ã®ç›®çš„åœ°ã¸å‘ã‹ã„ã¾ã™ï¼š\n${next.name}`);
      document.getElementById("info").innerText =
        `ç›®çš„åœ° ${currentIndex + 1}ï¼š${next.name}\nç¾åœ¨åœ°ã‚’å–å¾—ä¸­...`;
      return;
    }

    // --- æ–¹å‘çŸ¢å°ã‚’å›è»¢ ---
    document.getElementById("arrow").style.transform = `rotate(${correctedBearing}deg)`;

    // --- è¡¨ç¤ºæ›´æ–° ---
    document.getElementById("info").innerText =
      `ç›®çš„åœ° ${currentIndex + 1}ï¼š${target.name}\n` +
      `è·é›¢ï¼šç´„${distance.toFixed(1)}m\n` +
      `GPSç²¾åº¦ï¼š${gpsStatus}`;
  },
  err => {
    document.getElementById("info").innerText = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚";
  },
  { enableHighAccuracy: true });
}

// ==============================
//  ãƒœã‚¿ãƒ³
// ==============================
document.getElementById("startBtn").addEventListener("click", async () => {
  await enableOrientation();
  askDestination();
  document.getElementById("startBtn").style.display = "none";
});
</script>
</body>
</html>


