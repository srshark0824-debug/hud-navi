<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HUDãƒŠãƒ“ï¼ˆå®Œå…¨å®‰å®šç‰ˆï¼‰</title>
<style>
  body {
    background: black;
    color: rgb(0, 255, 13);
    font-family: monospace;
    text-align: center;
    margin-top: 10vh;
  }

  #arrow {
    width: 150px;
    height: 150px;
    margin: 0 auto;
    background: url('arrow.png') no-repeat center;
    background-size: contain;
    transform-origin: 50% 60%;
    transition: transform 0.2s linear;
    filter: drop-shadow(0 0 10px red);
  }

  #info {
    margin-top: 20px;
  }
</style>
</head>
<body>

<h2>HUDãƒŠãƒ“</h2>
<div id="arrow"></div>
<p id="info">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
<button id="startBtn">â–¶ï¸ ãƒŠãƒ“é–‹å§‹</button>

<script>
const API_KEY = "AIzaSyDHRitaxXlwj13-dz9zPKpwvhGZorwzgRY"; 
let destination = null;
let arrived = false;

// æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ç”¨
let heading = 0;
let headingHistory = [];
const declination = 7; // æ—¥æœ¬ã®ç£åè§’ï¼ˆæ±åç´„7Â°ï¼‰

// è·é›¢å¹³æ»‘åŒ–ç”¨
let distanceHistory = [];

// ===============================
//  1. æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯å–å¾—
// ===============================
async function enableOrientation() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    const permission = await DeviceOrientationEvent.requestPermission();
    if (permission !== "granted") {
      alert("ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ");
      return;
    }
  }

  // iPhone / Android ä¸¡å¯¾å¿œ
  window.addEventListener("deviceorientation", e => {
    let rawHeading = null;

    if (e.webkitCompassHeading !== undefined) {
      // iPhoneã¯ã‚³ãƒ³ãƒ‘ã‚¹æ–¹å‘ãŒãã®ã¾ã¾å¾—ã‚‰ã‚Œã‚‹
      rawHeading = e.webkitCompassHeading;
    } else if (e.alpha !== null) {
      // Androidã¯åº§æ¨™ç³»ãŒé€†ãªã®ã§å¤‰æ›
      rawHeading = (360 - e.alpha);
    }

    if (rawHeading != null) {
      // ç£åŒ— â†’ çœŸåŒ—è£œæ­£ï¼ˆæ—¥æœ¬ï¼‰
      rawHeading = (rawHeading + declination + 360) % 360;

      // 5ç‚¹ç§»å‹•å¹³å‡ã§å¹³æ»‘åŒ–
      headingHistory.push(rawHeading);
      if (headingHistory.length > 5) headingHistory.shift();
      heading = headingHistory.reduce((a, b) => a + b) / headingHistory.length;
    }
  });
}

// ===============================
//  2. åœ°åå…¥åŠ› â†’ Google API
// ===============================
async function askDestination() {
  const place = prompt("ç›®çš„åœ°ã®åœ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šäº¬éƒ½é§…ï¼‰");
  if (!place) return;

  const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(place)}&key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();

  if (data.results?.length > 0) {
    const loc = data.results[0].geometry.location;
    destination = { lat: loc.lat, lon: loc.lng };
    document.getElementById("info").innerText =
      `ç›®çš„åœ°ï¼š${place}\nç·¯åº¦:${loc.lat.toFixed(4)} çµŒåº¦:${loc.lng.toFixed(4)}\nGPSå–å¾—å¾…ã¡...`;
    startNavigation();
  } else {
    alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
    askDestination();
  }
}

// ===============================
//  3. è·é›¢è¨ˆç®—
// ===============================
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = d => d * Math.PI / 180;
  const Ï†1 = toRad(lat1);
  const Ï†2 = toRad(lat2);
  const Î”Ï† = toRad(lat2 - lat1);
  const Î”Î» = toRad(lon2 - lon1);
  const a = Math.sin(Î”Ï†/2)**2 +
            Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ===============================
//  4. æ–¹ä½è§’è¨ˆç®—
// ===============================
function getBearing(lat1, lon1, lat2, lon2) {
  const toRad = d => d * Math.PI / 180;
  const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
  const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
            Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

// ===============================
//  5. ãƒŠãƒ“é–‹å§‹ï¼ˆGPSè¿½è·¡ï¼‰
// ===============================
function startNavigation() {
  navigator.geolocation.watchPosition(pos => {
    if (arrived) return;

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;

    const bearing = getBearing(lat, lon, destination.lat, destination.lon);
    let distance = getDistance(lat, lon, destination.lat, destination.lon);

    // GPSç²¾åº¦ãŒæ‚ªã„æ™‚ã¯è·é›¢æ›´æ–°ã—ãªã„
    if (acc < 50) {
      distanceHistory.push(distance);
      if (distanceHistory.length > 3) distanceHistory.shift();
      distance = distanceHistory.reduce((a, b) => a + b) / distanceHistory.length;
    }

    // â˜… ã“ã“ãŒæœ€é‡è¦ï¼šçŸ¢å°ã®å‘ãè£œæ­£
    const correctedBearing = (bearing - heading + 360) % 360;

    // åˆ°ç€åˆ¤å®šï¼ˆç²¾åº¦ã‚‚è€ƒæ…®ï¼‰
    if (distance < 50 && acc < 30) {
      arrived = true;
      document.getElementById("arrow").style.display = "none";
      document.getElementById("info").innerText = "ğŸ‰ ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸ";
      return;
    }

    document.getElementById("arrow").style.transform =
      `rotate(${correctedBearing}deg)`;

    document.getElementById("info").innerText =
      `è·é›¢ï¼šç´„${distance.toFixed(1)}m\n` +
      `æ–¹ä½ï¼š${bearing.toFixed(1)}Â°\n` +
      `ç«¯æœ«å‘ãï¼š${heading.toFixed(1)}Â°\n` +
      `GPSç²¾åº¦ï¼š${acc.toFixed(1)}m`;
  }, err => {
    document.getElementById("info").innerText = "GPSãŒå–å¾—ã§ãã¾ã›ã‚“";
  }, { enableHighAccuracy: true, maximumAge: 0 });
}

// ===============================
//  6. ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
// ===============================
document.getElementById("startBtn").addEventListener("click", async () => {
  await enableOrientation();
  askDestination();
  document.getElementById("startBtn").style.display = "none";
});
</script>

</body>
</html>

