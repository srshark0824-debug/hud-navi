<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HUDãƒŠãƒ“ï¼ˆãƒŠãƒ“è‡ªå‹•åˆ‡æ›¿ï¼‰</title>

<style>
  body {
    background: black;
    color: rgb(0, 255, 13);
    font-family: monospace;
    text-align: center;
    margin-top: 7vh;
  }

  #arrow {
    width: 150px;
    height: 150px;
    margin: 0 auto;
    background: url('arrow.png') no-repeat center;
    background-size: contain;
    transform-origin: 50% 60%;
    transition: transform 0.3s linear;
    filter: drop-shadow(0 0 10px red);
  }

  #info {
    margin-top: 15px;
    white-space: pre-line;
  }
</style>
</head>

<body>
  <h2>HUDãƒŠãƒ“</h2>
  <div id="arrow"></div>
  <p id="info">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
  <button id="startBtn">â–¶ï¸ ãƒŠãƒ“é–‹å§‹</button>

<script>
const API_KEY = "AIzaSyDHRitaxXlwj13-dz9zPKpwvhGZorwzgRY"; // â†å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´
let waypoints = [];             // ç›®çš„åœ°ãƒªã‚¹ãƒˆ
let currentIndex = 0;           // ç¾åœ¨ã®ç›®çš„åœ°
let arrived = false;

// æ–¹ä½å®‰å®šåŒ–ãƒãƒƒãƒ•ã‚¡
let headingOffset = 0;
let headingHistory = [];

// --------------------------------------
// â‘  æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ï¼‹å®‰å®šåŒ–
// --------------------------------------
async function enableOrientation() {
  if (typeof DeviceOrientationEvent.requestPermission === "function") {
    const permission = await DeviceOrientationEvent.requestPermission();
    if (permission !== "granted") {
      alert("ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚");
      return;
    }
  }

  // æ–¹ä½ã®æºã‚Œã‚’ç§»å‹•å¹³å‡ã§å¹³æ»‘åŒ–
  window.addEventListener("deviceorientation", e => {
    let heading;

    // iPhoneå°‚ç”¨ã®æ­£ç¢ºãªã‚³ãƒ³ãƒ‘ã‚¹å€¤
    if (e.webkitCompassHeading !== undefined) {
      heading = e.webkitCompassHeading;
    }
    // ãã®ä»–ç«¯æœ«
    else if (e.alpha !== null) {
      heading = 360 - e.alpha;
    }

    if (heading !== undefined) {
      headingHistory.push(heading);
      if (headingHistory.length > 5) headingHistory.shift();
      const avg = headingHistory.reduce((a, b) => a + b, 0) / headingHistory.length;
      headingOffset = avg;
    }
  });
}

// --------------------------------------
// ç›®çš„åœ°å…¥åŠ›ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
// --------------------------------------
async function inputDestinations() {

  while (true) {
    const place = prompt(
      `ç›®çš„åœ° ${waypoints.length + 1} ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nä¾‹ï¼šäº¬éƒ½é§…\nã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§çµ‚äº†ã—ã¾ã™ã€‚`
    );

    if (!place) break;

    // Geocode API ã¸å•ã„åˆã‚ã›
    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(place)}&key=${API_KEY}`;
    const res = await fetch(url);
    const data = await res.json();

    if (!data.results.length) {
      alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      continue;
    }

    const result = data.results[0];

    // ğŸ”µ ã“ã“ãŒé‡è¦ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¨Googleä½æ‰€ã®ä¸¡æ–¹ã‚’è¡¨ç¤º
    const ok = confirm(
      `ã€Œ${place}ï¼ˆæ¨å®šï¼š${result.formatted_address}ï¼‰ã€ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`
    );

    if (!ok) continue;

    // ğŸ”µ ä¿å­˜ã™ã‚‹ name ã¯ã€ŒGoogleä½æ‰€ã€ã§ã¯ãªãã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›æ–‡å­—åˆ—ã€
    waypoints.push({
      name: place,
      lat: result.geometry.location.lat,
      lon: result.geometry.location.lng
    });
  }

  if (waypoints.length === 0) {
    alert("ç›®çš„åœ°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return false;
  }

  return true;
}

// --------------------------------------
// è·é›¢è¨ˆç®—ï¼ˆHaversineï¼‰
// --------------------------------------
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Î”Ï†/2)**2 +
            Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c;
}

// --------------------------------------
// æ–¹ä½è§’è¨ˆç®—
// --------------------------------------
function getBearing(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI/180;
  const y = Math.sin(toRad(lon2-lon1)) * Math.cos(toRad(lat2));
  const x = Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) -
            Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
  const brng = Math.atan2(y, x);
  return (brng * 180 / Math.PI + 360) % 360;
}

// --------------------------------------
// ãƒŠãƒ“é–‹å§‹ï¼ˆè¤‡æ•°ç›®çš„åœ°å¯¾å¿œï¼‰
// --------------------------------------
function startNavigation() {
  let lastPos = null;  // for movement-based heading
  let distancePrev = null;

  navigator.geolocation.watchPosition((pos) => {
    // å¿…è¦ãªå€¤ã‚’ä¸€å›ã ã‘å®£è¨€ï¼ˆé‡è¤‡å®£è¨€ã‚’é¿ã‘ã‚‹ï¼‰
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;

    // ---â˜… æ”¹å–„æ¡ˆCï¼ˆæ­©è¡Œæ–¹å‘ã®åˆ©ç”¨ï¼‰â˜…---
    if (lastPos) {
      const moved = getDistance(lastPos.lat, lastPos.lon, lat, lon);
      if (moved > 2) {
        const headingMove = getBearing(lastPos.lat, lastPos.lon, lat, lon);
        // å°‘ã—å¹³æ»‘åŒ–ã—ã¦ä¸Šæ›¸ãï¼ˆæ€¥æ¿€ãªã‚¸ãƒ£ãƒ³ãƒ—ã‚’é˜²ãï¼‰
        headingOffset = (headingOffset * 0.4) + (headingMove * 0.6);
      }
    }
    lastPos = { lat, lon };
    // ---â˜… æ”¹å–„æ¡ˆC çµ‚äº† â˜…---

    if (arrived) return;

    const target = waypoints[currentIndex];

    const bearing = getBearing(lat, lon, target.lat, target.lon);
    let distance = getDistance(lat, lon, target.lat, target.lon);

    // GPS ç²¾åº¦ãŒæ‚ªã„ã¨ãã¯è·é›¢ã‚’å¹³æ»‘åŒ–ã™ã‚‹ï¼ˆé£›ã³å¯¾ç­–ï¼‰
    if (distancePrev !== null && acc > 30) {
      distance = (distancePrev * 0.7) + (distance * 0.3);
    }
    distancePrev = distance;

    // æ–¹ä½è£œæ­£ï¼ˆç›®çš„åœ°æ–¹ä½ - ç«¯æœ«å‘ãï¼‰
    const correctedBearing = (bearing - headingOffset + 360) % 360;

    // GPS ç²¾åº¦ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆã€‡ â–³ âœ–ï¼‰
    let gpsStatus = "ã€‡";
    if (acc > 30) gpsStatus = "â–³";
    if (acc > 100) gpsStatus = "âœ–";

    // åˆ°ç€åˆ¤å®šï¼ˆç²¾åº¦ã‚‚åŠ å‘³ï¼‰
    if (distance < 50 && acc < 30) {
      const nextName = (currentIndex + 1 < waypoints.length) ? waypoints[currentIndex + 1].name : null;
      if (!nextName) {
        arrived = true;
        document.getElementById("info").innerText = "ğŸ‰ å…¨ã¦ã®ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸï¼";
        document.getElementById("arrow").style.display = "none";
        return;
      }

      document.getElementById("info").innerText =
        `ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸï¼\n\næ¬¡ã®ç›®çš„åœ°ã«å‘ã‹ã„ã¾ã™ï¼š${nextName}\n5ç§’å¾Œã«è‡ªå‹•ã§ãƒŠãƒ“ã‚’å†é–‹ã—ã¾ã™â€¦`;

      arrived = true;

      setTimeout(() => {
        currentIndex++;
        arrived = false;
      }, 5000);

      return;
    }

    // ç”»é¢æ›´æ–°
    document.getElementById("arrow").style.transform = `rotate(${correctedBearing}deg)`;
    document.getElementById("info").innerText =
      `æ¬¡ã®ç›®çš„åœ°ï¼š${target.name} (${currentIndex+1}/${waypoints.length})\n` +
      `è·é›¢ï¼šç´„${distance.toFixed(1)} m\n` +
      `GPSç²¾åº¦ï¼š${gpsStatus}`;

  }, err => {
    document.getElementById("info").innerText = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚";
  }, { enableHighAccuracy: true });
}

// --------------------------------------
// ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
// --------------------------------------
document.getElementById("startBtn").addEventListener("click", async () => {
  await enableOrientation();

  const ok = await inputDestinations();
  if (!ok) return;

  document.getElementById("startBtn").style.display = "none";
  startNavigation();
});
</script>

</body>
</html>

