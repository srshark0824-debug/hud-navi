<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HUDナビ（画像矢印版）</title>
<style>
  body {
    background: black;
    color: rgb(0, 255, 13);
    font-family: monospace;
    text-align: center;
    margin-top: 10vh;
  }

  /* ▼ 矢印画像のスタイル */
  #arrow {
    width: 150px;
    height: 150px;
    margin: 0 auto;
    background: url('arrow.png') no-repeat center;
    background-size: contain;
    transform-origin: 50% 60%; /* 回転の支点を少し下に設定 */
    transition: transform 0.3s linear;
    filter: drop-shadow(0 0 10px red); /* 光の演出を追加 */
  }

  #info {
    margin-top: 20px;
  }
</style>
</head>
<body>
  <h2>HUDナビ</h2>
  <div id="arrow"></div> <!-- 矢印を画像として表示 -->
  <p id="info">目的地を設定してください。</p>
  <button id="startBtn">▶️ ナビ開始</button>

<script>
const API_KEY = "AIzaSyDHRitaxXlwj13-dz9zPKpwvhGZorwzgRY";
let destination = null;
let headingOffset = 0;
let arrived = false;

let headingHistory = []; //過去の方位値を保持して平均化

// ✅ センサー許可をリクエスト
async function enableOrientation() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    const permission = await DeviceOrientationEvent.requestPermission();
    if (permission === 'granted') {
    
  // ✅【変更】方位の揺れを平滑化（5件平均）
      window.addEventListener("deviceorientation", e => {
        if (e.alpha !== null) {
          const newHeading = 360 - e.alpha;
          headingHistory.push(newHeading);
          if (headingHistory.length > 5) headingHistory.shift();
          const avgHeading = headingHistory.reduce((a, b) => a + b, 0) / headingHistory.length;
          headingOffset = avgHeading;
        }
      });
      
    } else {
      alert("センサーアクセスが拒否されました。");
    }
  } else {
   // ✅【変更】iPhone以外でも動作するように調整
    window.addEventListener("deviceorientation", e => {
      if (e.alpha !== null) {
        const newHeading = 360 - e.alpha;
        headingHistory.push(newHeading);
        if (headingHistory.length > 5) headingHistory.shift();
        const avgHeading = headingHistory.reduce((a, b) => a + b, 0) / headingHistory.length;
        headingOffset = avgHeading;
      }
    });
  }
}

// ✅ 地名入力＆API呼び出し
async function askDestination() {
  const place = prompt("目的地の地名を入力してください（例：東京駅）");
  if (!place) return;

  const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(place)}&key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();

  if (data.results.length > 0) {
    const loc = data.results[0].geometry.location;
    destination = { lat: loc.lat, lon: loc.lng };
    document.getElementById("info").innerText =
      `目的地：${place}\n(${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)})\n現在地を取得中...`;
    startNavigation();
  } else {
    alert("場所が見つかりませんでした。");
    askDestination();
  }
}

// ✅ 距離計算
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(Δφ / 2) ** 2 +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// ✅ 方位角計算
function getBearing(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI / 180;
  const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
  const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
            Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
  const brng = Math.atan2(y, x);
  return (brng * 180 / Math.PI + 360) % 360;
}

// ✅【変更】ナビゲーション関数：GPS精度の表示を追加
function startNavigation() {
  navigator.geolocation.watchPosition(pos => {
    if (arrived) return;

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    //const acc = pos.coords.accuracy; // ✅ GPS精度[m]

    const bearing = getBearing(lat, lon, destination.lat, destination.lon);
    const distance = getDistance(lat, lon, destination.lat, destination.lon);
    const correctedBearing = (bearing - headingOffset + 360) % 360;

    // ✅【追加】GPS精度の評価
    let gpsStatus = "○";
    if (acc > 30) gpsStatus = "△";
    if (acc > 100) gpsStatus = "×";

    // ✅【変更】到着判定に精度条件を追加
    if (distance < 50 && acc < 30) {
      arrived = true;
      document.getElementById("info").innerText = "🎉 目的地に到着しました！";
      document.getElementById("arrow").style.display = "none";
      return;
    }

    // ✅【変更】表示内容を詳細化
    document.getElementById("arrow").style.transform = `rotate(${correctedBearing}deg)`;
    document.getElementById("info").innerText =
      `距離：約${distance.toFixed(1)}m\n方位：${bearing.toFixed(1)}°\n補正：${headingOffset.toFixed(1)}°\nGPS精度：${acc.toFixed(1)}m（${gpsStatus}）`;
  }, err => {
    document.getElementById("info").innerText = "位置情報が取得できません。";
  }, { enableHighAccuracy: true });
}

// ✅ ボタン動作設定
document.getElementById("startBtn").addEventListener("click", async () => {
  await enableOrientation();
  askDestination();
  document.getElementById("startBtn").style.display = "none";
});
</script>
</body>
</html>









