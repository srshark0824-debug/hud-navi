<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HUDãƒŠãƒ“ï¼ˆçµŒè·¯æ¡ˆå†…å¯¾å¿œç‰ˆï¼‰</title>
<style>
  body {
    background: black;
    color: rgb(0, 255, 13);
    font-family: monospace;
    text-align: center;
    margin-top: 10vh;
  }

  #arrow {
    width: 150px;
    height: 150px;
    margin: 0 auto;
    background: url('arrow.png') no-repeat center;
    background-size: contain;
    transform-origin: 50% 60%;
    transition: transform 0.3s linear;
    filter: drop-shadow(0 0 10px red);
  }

  #info {
    margin-top: 20px;
    white-space: pre-line;
  }
</style>
</head>
<body>
  <h2>HUDãƒŠãƒ“</h2>
  <div id="arrow"></div>
  <p id="info">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
  <button id="startBtn">â–¶ï¸ ãƒŠãƒ“é–‹å§‹</button>

<script>
const API_KEY = "AIzaSyDHRitaxXlwj13-dz9zPKpwvhGZorwzgRY"; // ğŸ”’å®Ÿé‹ç”¨æ™‚ã¯å®‰å…¨ãªå ´æ‰€ã«ä¿ç®¡
let destination = null;
let routeSteps = [];  // âœ… çµŒè·¯æƒ…å ±ã‚’ä¿å­˜
let currentStepIndex = 0;
let headingOffset = 0;
let arrived = false;
let headingHistory = [];

// âœ… ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã¨æ–¹ä½ã®å®‰å®šåŒ–ï¼ˆå‰å›ã¨åŒæ§˜ï¼‰
async function enableOrientation() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    const permission = await DeviceOrientationEvent.requestPermission();
    if (permission === 'granted') {
      window.addEventListener("deviceorientation", e => {
        if (e.alpha !== null) {
          const newHeading = 360 - e.alpha;
          headingHistory.push(newHeading);
          if (headingHistory.length > 5) headingHistory.shift();
          headingOffset = headingHistory.reduce((a, b) => a + b, 0) / headingHistory.length;
        }
      });
    }
  } else {
    window.addEventListener("deviceorientation", e => {
      if (e.alpha !== null) {
        const newHeading = 360 - e.alpha;
        headingHistory.push(newHeading);
        if (headingHistory.length > 5) headingHistory.shift();
        headingOffset = headingHistory.reduce((a, b) => a + b, 0) / headingHistory.length;
      }
    });
  }
}

// âœ… åœ°åå…¥åŠ› â†’ åº§æ¨™å–å¾—
async function askDestination() {
  const place = prompt("ç›®çš„åœ°ã®åœ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šäº¬éƒ½é§…ï¼‰");
  if (!place) return;

  const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(place)}&key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();

  if (data.results.length > 0) {
    const loc = data.results[0].geometry.location;
    destination = { lat: loc.lat, lon: loc.lng };
    document.getElementById("info").innerText =
      `ç›®çš„åœ°ï¼š${place}\n(${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)})\nçµŒè·¯ã‚’å–å¾—ä¸­...`;
    await fetchRoute(); // âœ… çµŒè·¯å–å¾—
  } else {
    alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
}

// âœ…ã€æ–°è¦è¿½åŠ ã€‘Google Directions APIã‹ã‚‰çµŒè·¯ã‚’å–å¾—
async function fetchRoute() {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(async pos => {
      const origin = `${pos.coords.latitude},${pos.coords.longitude}`;
      const destinationStr = `${destination.lat},${destination.lon}`;
      const url = `https://maps.googleapis.com/maps/api/directions/json?origin=${origin}&destination=${destinationStr}&mode=walking&key=${API_KEY}`;

      const res = await fetch(url);
      const data = await res.json();

      if (data.routes && data.routes.length > 0) {
        // âœ… æœ€åˆã®ãƒ«ãƒ¼ãƒˆã‚’å–å¾—
        routeSteps = data.routes[0].legs[0].steps.map(step => ({
          lat: step.end_location.lat,
          lon: step.end_location.lng,
          instruction: step.html_instructions.replace(/<[^>]+>/g, '') // HTMLé™¤å»
        }));

        document.getElementById("info").innerText =
          `çµŒè·¯ã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆå…¨${routeSteps.length}åŒºé–“ï¼‰\nãƒŠãƒ“ã‚’é–‹å§‹ã—ã¾ã™...`;
        startNavigation();
        resolve();
      } else {
        alert("çµŒè·¯ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        reject();
      }
    }, err => {
      alert("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚");
      reject();
    });
  });
}

// âœ… è·é›¢è¨ˆç®—
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(Î”Ï† / 2) ** 2 +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î» / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// âœ… æ–¹ä½è§’è¨ˆç®—
function getBearing(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI / 180;
  const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
  const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
            Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
  const brng = Math.atan2(y, x);
  return (brng * 180 / Math.PI + 360) % 360;
}

// âœ…ã€å¤‰æ›´ã€‘çµŒè·¯ã‚¹ãƒ†ãƒƒãƒ—ã«æ²¿ã£ã¦ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
function startNavigation() {
  navigator.geolocation.watchPosition(pos => {
    if (arrived) return;

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;
    const currentStep = routeSteps[currentStepIndex];
    const distance = getDistance(lat, lon, currentStep.lat, currentStep.lon);
    const bearing = getBearing(lat, lon, currentStep.lat, currentStep.lon);
    const correctedBearing = (bearing - headingOffset + 360) % 360;

    // âœ… è·é›¢ãŒè¿‘ã„å ´åˆ â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€
    if (distance < 30 && currentStepIndex < routeSteps.length - 1) {
      currentStepIndex++;
    }

    // âœ… ã™ã¹ã¦å®Œäº†
    if (currentStepIndex >= routeSteps.length - 1 && distance < 30) {
      arrived = true;
      document.getElementById("arrow").style.display = "none";
      document.getElementById("info").innerText = "ğŸ‰ ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸï¼";
      return;
    }

    // âœ… è¡¨ç¤ºæ›´æ–°
    document.getElementById("arrow").style.transform = `rotate(${correctedBearing}deg)`;
    document.getElementById("info").innerText =
      `è·é›¢ï¼šç´„${distance.toFixed(1)}m\næ–¹ä½ï¼š${bearing.toFixed(1)}Â°\nè£œæ­£ï¼š${headingOffset.toFixed(1)}Â°\n${routeSteps[currentStepIndex].instruction}\nGPSç²¾åº¦ï¼š${acc.toFixed(1)}m`;
  }, err => {
    document.getElementById("info").innerText = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚";
  }, { enableHighAccuracy: true });
}

// âœ… ãƒœã‚¿ãƒ³
document.getElementById("startBtn").addEventListener("click", async () => {
  await enableOrientation();
  askDestination();
  document.getElementById("startBtn").style.display = "none";
});
</script>
</body>
</html>

