<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HUDãƒŠãƒ“ï¼ˆè¤‡æ•°ç›®çš„åœ°ãƒ«ãƒ¼ãƒˆå¯¾å¿œï¼‰</title>
<style>
  body {
    background: black;
    color: rgb(0,255,13);
    font-family: monospace;
    text-align: center;
    margin-top: 10vh;
  }

  #arrow {
    width: 150px;
    height: 150px;
    margin: 0 auto;
    background: url('arrow.png') no-repeat center;
    background-size: contain;
    transform-origin: 50% 60%;
    transition: transform 0.3s linear;
    filter: drop-shadow(0 0 10px red);
  }

  #info { margin-top: 20px; }
</style>
</head>
<body>

<h2>HUDãƒŠãƒ“</h2>
<div id="arrow"></div>
<p id="info">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
<button id="startBtn">â–¶ï¸ ãƒŠãƒ“é–‹å§‹</button>

<script>
/* ===========================
    è¨­å®š
=========================== */
const API_KEY = "YOUR_API_KEY_HERE";   // â†ã‚ãªãŸã®ã‚­ãƒ¼ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
let waypoints = [];                    // è¤‡æ•°ç›®çš„åœ°
let currentIndex = 0;                  // ä»Šå‘ã‹ã£ã¦ã„ã‚‹ç›®çš„åœ°
let headingOffset = 0;                 // ã‚»ãƒ³ã‚µãƒ¼è£œæ­£å€¤
let arrived = false;

/* æ–¹ä½å®‰å®šåŒ–ãƒãƒƒãƒ•ã‚¡ */
let headingHistory = [];

/* ===========================
    ãƒ‡ãƒã‚¤ã‚¹æ–¹ä½ã®è¨±å¯
=========================== */
async function enableOrientation() {
  if (typeof DeviceOrientationEvent.requestPermission === "function") {
    const permission = await DeviceOrientationEvent.requestPermission();
    if (permission !== "granted") {
      alert("ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ");
      return;
    }
  }

  window.addEventListener("deviceorientation", e => {
    if (e.alpha == null) return;

    // iPhoneï¼šåŒ—=0Â°ã€Androidï¼šåŒ—=Î±ã®ã¾ã¾ç­‰ ç«¯æœ«å·®ãŒã‚ã‚‹
    const newHeading = 360 - e.alpha;
    headingHistory.push(newHeading);

    if (headingHistory.length > 5) headingHistory.shift();

    const avg = headingHistory.reduce((a,b)=>a+b,0) / headingHistory.length;
    headingOffset = avg;
  });
}

/* ===========================
    åœ°åå…¥åŠ› â†’ Google Geocode
=========================== */
async function inputDestination() {
  while (true) {
    const place = prompt(`ç›®çš„åœ° ${waypoints.length+1} ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šäº¬éƒ½é§…ï¼‰\nã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§çµ‚äº†ã—ã¾ã™ã€‚`);
    if (!place) return false; // å…¥åŠ›çµ‚äº†

    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(place)}&key=${API_KEY}`;
    const res = await fetch(url);
    const data = await res.json();

    if (data.results.length === 0) {
      alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å…¥åŠ›ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
      continue;
    }

    // æœ€ã‚‚ãƒãƒƒãƒã—ãŸå€™è£œ
    const result = data.results[0];

    // ä½ç½®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    const ok = confirm(`ã€Œ${result.formatted_address}ã€ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
    if (!ok) continue;

    waypoints.push({
      name: result.formatted_address,
      lat: result.geometry.location.lat,
      lon: result.geometry.location.lng
    });

    const addMore = confirm("æ¬¡ã®ç›®çš„åœ°ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ");
    if (!addMore) return true;
  }
}

/* ===========================
    è·é›¢è¨ˆç®—
=========================== */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ===========================
    æ–¹ä½è§’è¨ˆç®—
=========================== */
function getBearing(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI / 180;
  const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
  const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
            Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.cos(toRad(lon2 - lon1));
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

/* ===========================
    ãƒŠãƒ“é–‹å§‹
=========================== */
function startNavigation() {
  navigator.geolocation.watchPosition(pos => {
    if (arrived) return;

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;

    const target = waypoints[currentIndex];

    const distance = getDistance(lat, lon, target.lat, target.lon);
    const bearing = getBearing(lat, lon, target.lat, target.lon);

    const correctedBearing = (bearing - headingOffset + 360) % 360;

    // GPSç²¾åº¦åˆ¤å®šï¼ˆã€‡ â–³ Ã—ï¼‰
    let gpsStatus = "ã€‡";
    if (acc > 30) gpsStatus = "â–³";
    if (acc > 100) gpsStatus = "âœ–";

    // åˆ°ç€åˆ¤å®š
    if (distance < 50 && acc < 30) {
      currentIndex++;

      if (currentIndex >= waypoints.length) {
        arrived = true;
        document.getElementById("arrow").style.display = "none";
        document.getElementById("info").innerText = "ğŸ‰ å…¨ã¦ã®ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸï¼";
        return;
      }

      alert(`ç›®çš„åœ°ã€Œ${target.name}ã€ã«åˆ°ç€ï¼\næ¬¡ã®ç›®çš„åœ°ã«ç§»å‹•ã—ã¾ã™ã€‚`);
      return;
    }

    // ç”»é¢æ›´æ–°
    document.getElementById("arrow").style.transform = `rotate(${correctedBearing}deg)`;
    document.getElementById("info").innerText =
      `æ¬¡ã®ç›®çš„åœ°ï¼š${target.name} (${currentIndex+1}/${waypoints.length})\n` +
      `è·é›¢ï¼š${distance.toFixed(1)}m\n` +
      `GPSç²¾åº¦ï¼š${gpsStatus}`;
  },
  err => {
    document.getElementById("info").innerText = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚";
  }, {
    enableHighAccuracy: true
  });
}

/* ===========================
    ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
=========================== */
document.getElementById("startBtn").addEventListener("click", async () => {
  await enableOrientation();

  const ok = await inputDestination();
  if (!ok || waypoints.length === 0) {
    alert("ç›®çš„åœ°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  document.getElementById("startBtn").style.display = "none";
  startNavigation();
});
</script>

</body>
</html>
